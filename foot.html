<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curves AI - ä¸‹è‚¢ç©©å®šèˆ‡è¶³å¼“åµæ¸¬</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    
    <style>
        body { margin: 0; background-color: #2c3e50; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; }
        #status-bar { width: 100%; padding: 20px; text-align: center; font-size: 24px; font-weight: bold; background-color: #34495e; transition: background-color 0.3s; }
        .container { position: relative; width: 95%; max-width: 640px; margin-top: 20px; }
        video { display: none; }
        canvas { width: 100%; border-radius: 15px; border: 4px solid #7f8c8d; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        
        /* å…è²¬è²æ˜å½ˆçª— */
        #disclaimer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 999; }
        .modal-content { background: #fff; color: #333; padding: 30px; border-radius: 15px; width: 85%; max-width: 450px; text-align: center; }
        .modal-content h2 { color: #e74c3c; margin-top: 0; }
        .modal-content p { font-size: 15px; line-height: 1.6; text-align: justify; }
        button#agree-btn { background: #9b59b6; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; margin-top: 20px; width: 100%; transition: background 0.2s; }
        button#agree-btn:hover { background: #8e44ad; }
    </style>
</head>
<body>

    <div id="disclaimer-modal">
        <div class="modal-content">
            <h2>âš ï¸ ç³»çµ±ä½¿ç”¨è²æ˜</h2>
            <p>æœ¬ç³»çµ±æ‰€æä¾›ä¹‹å§¿æ…‹æ•¸æ“šèˆ‡è¼”åŠ©ç·šåƒ…ä¾›åƒè€ƒï¼Œ<strong>ä¸å…·å‚™ä»»ä½•é†«ç™‚ã€å¾©å¥æˆ–å°ˆæ¥­è¨ºæ–·å»ºè­°ä¹‹æ•ˆåŠ›</strong>ã€‚</p>
            <p>ä½¿ç”¨è€…è«‹è‡ªè¡Œè©•ä¼°èº«é«”ç‹€æ³ï¼Œè‹¥å› åƒè€ƒæœ¬ç³»çµ±æ•¸æ“šè€Œç”¢ç”Ÿä¹‹ä»»ä½•æå‚·ï¼Œé–‹ç™¼è€…æ¦‚ä¸è² æå®³è³ å„Ÿè²¬ä»»ã€‚</p>
            <button id="agree-btn">æˆ‘å·²è©³é–±ä¸¦åŒæ„</button>
        </div>
    </div>

    <div id="status-bar">ç­‰å¾…æ”å½±æ©Ÿå•Ÿå‹•...</div>
    
    <div class="container">
        <video id="input_video" autoplay playsinline></video>
        <canvas id="output_canvas" width="640" height="480"></canvas>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const statusBar = document.getElementById('status-bar');

        document.getElementById('agree-btn').addEventListener('click', () => {
            document.getElementById('disclaimer-modal').style.display = 'none';
            statusBar.innerText = "è«‹é€€å¾Œï¼Œè®“é¡é ­æ‹åˆ°æ‚¨çš„è†è“‹èˆ‡è…³éƒ¨...";
            startCamera();
        });

        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                // æŠ“å–é—œéµé»ï¼šè†è“‹ (25, 26) èˆ‡ è…³è¸ (27, 28)
                const leftKnee = results.poseLandmarks[25];
                const rightKnee = results.poseLandmarks[26];
                const leftAnkle = results.poseLandmarks[27];
                const rightAnkle = results.poseLandmarks[28];

                // ğŸŒŸ å¯è¦‹åº¦é˜²å‘†ï¼šç¢ºä¿æ•´æ¢å°è…¿éƒ½æœ‰å…¥é¡ (é–¾å€¼ 0.6)
                const isLeftVisible = leftKnee.visibility > 0.6 && leftAnkle.visibility > 0.6;
                const isRightVisible = rightKnee.visibility > 0.6 && rightAnkle.visibility > 0.6;

                if (!isLeftVisible && !isRightVisible) {
                    statusBar.innerText = "âŒ æœªåµæ¸¬åˆ°å®Œæ•´å°è…¿ï¼Œè«‹é€€å¾Œä¸€é»";
                    statusBar.style.backgroundColor = "#555";
                    canvasCtx.restore();
                    return; 
                }

                // ç•«å‡ºå°è…¿é€£ç·š (è¦–è¦ºå›é¥‹ï¼Œè®“å­¸å“¡è‡ªå·±çœ‹æœ‰æ²’æœ‰æ­ª)
                canvasCtx.lineWidth = 4;
                if (isLeftVisible) {
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(leftKnee.x * canvasElement.width, leftKnee.y * canvasElement.height);
                    canvasCtx.lineTo(leftAnkle.x * canvasElement.width, leftAnkle.y * canvasElement.height);
                    canvasCtx.strokeStyle = '#3498db'; // è—è‰²ç·šæ¢
                    canvasCtx.stroke();
                }
                if (isRightVisible) {
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(rightKnee.x * canvasElement.width, rightKnee.y * canvasElement.height);
                    canvasCtx.lineTo(rightAnkle.x * canvasElement.width, rightAnkle.y * canvasElement.height);
                    canvasCtx.strokeStyle = '#3498db'; 
                    canvasCtx.stroke();
                }

                // ğŸŒŸ é‚è¼¯åˆ¤æ–·ï¼šå°è…¿ X è»¸çš„åç§»é‡ (å‚¾æ–œç¨‹åº¦)
                // æ•¸å€¼è¶Šå¤§ï¼Œä»£è¡¨å…è¨±çš„å‚¾æ–œè§’åº¦è¶Šå¤§ã€‚ä½ å¯ä»¥æ ¹æ“šå­¸å“¡ç‹€æ³å¾®èª¿é€™å€‹æ•¸å­—
                const skewThreshold = 0.05; 
                let statusText = "âœ… ä¸‹è‚¢å°é½Šèˆ‡è¶³éƒ¨æ”¯æ’è‰¯å¥½";
                let statusColor = "#27ae60"; 

                if (isLeftVisible) {
                    // è¨ˆç®—å·¦å°è…¿çš„ X è»¸è½å·®
                    const leftSkew = Math.abs(leftKnee.x - leftAnkle.x);
                    if (leftSkew > skewThreshold) {
                        statusText = "âš ï¸ å·¦è†å…§æ‰£ / è¶³å¼“å¯èƒ½å¡Œé™·";
                        statusColor = "#e74c3c"; 
                    }
                }

                if (isRightVisible) {
                    const rightSkew = Math.abs(rightKnee.x - rightAnkle.x);
                    if (rightSkew > skewThreshold) {
                        statusText = "âš ï¸ å³è†å…§æ‰£ / è¶³å¼“å¯èƒ½å¡Œé™·";
                        statusColor = "#e74c3c"; 
                    }
                }

                statusBar.innerText = statusText;
                statusBar.style.backgroundColor = statusColor;
            } else {
                statusBar.innerText = "è«‹ç«™åˆ°é¡é ­å‰æ–¹...";
                statusBar.style.backgroundColor = "#555";
            }
            canvasCtx.restore();
        }

        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        pose.onResults(onResults);

        function startCamera() {
            const camera = new Camera(videoElement, {
                onFrame: async () => { await pose.send({image: videoElement}); },
                width: 640, height: 480
            });
            camera.start();
        }
    </script>
</body>
</html>