<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curves AI - è¶³è¸ç©©å®šåµæ¸¬ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    
    <style>
        body { margin: 0; background-color: #2c3e50; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; }
        #status-bar { width: 100%; padding: 20px; text-align: center; font-size: 26px; font-weight: bold; background-color: #34495e; transition: background-color 0.3s; }
        .container { position: relative; width: 95%; max-width: 640px; margin-top: 20px; }
        video { display: none; }
        canvas { width: 100%; border-radius: 15px; border: 4px solid #7f8c8d; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        
        /* å…è²¬è²æ˜å½ˆçª— (ç¡¬é«”é€£é–æ©Ÿåˆ¶) */
        #disclaimer-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 999;
        }
        .modal-content {
            background: #fff; color: #333; padding: 30px; border-radius: 15px; width: 85%; max-width: 450px; text-align: center;
        }
        .modal-content h2 { color: #e74c3c; margin-top: 0; }
        .modal-content p { font-size: 15px; line-height: 1.6; text-align: justify; }
        button#agree-btn { background: #9b59b6; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; margin-top: 20px; width: 100%; transition: background 0.2s; }
        button#agree-btn:hover { background: #8e44ad; }
    </style>
</head>
<body>

    <div id="disclaimer-modal">
        <div class="modal-content">
            <h2>âš ï¸ ç³»çµ±ä½¿ç”¨è²æ˜</h2>
            <p>æœ¬ç³»çµ±æ‰€æä¾›ä¹‹å§¿æ…‹æ•¸æ“šèˆ‡è¼”åŠ©ç·šåƒ…ä¾›åƒè€ƒï¼Œ<strong>ä¸å…·å‚™ä»»ä½•é†«ç™‚ã€å¾©å¥æˆ–å°ˆæ¥­è¨ºæ–·å»ºè­°ä¹‹æ•ˆåŠ›</strong>ã€‚</p>
            <p>ä½¿ç”¨è€…æ–¼æ“ä½œéç¨‹ä¸­è«‹è‡ªè¡Œè©•ä¼°èº«é«”ç‹€æ³ï¼Œè‹¥æ„Ÿä¸é©è«‹ç«‹å³åœæ­¢ã€‚è‹¥å› åƒè€ƒæœ¬ç³»çµ±æ•¸æ“šè€Œç”¢ç”Ÿä¹‹ä»»ä½•æ„å¤–æˆ–æå‚·ï¼Œé–‹ç™¼è€…èˆ‡æä¾›æ–¹æ¦‚ä¸è² æå®³è³ å„Ÿè²¬ä»»ã€‚</p>
            <button id="agree-btn">æˆ‘å·²è©³é–±ä¸¦åŒæ„</button>
        </div>
    </div>

    <div id="status-bar">ç­‰å¾…æ”å½±æ©Ÿå•Ÿå‹•...</div>
    
    <div class="container">
        <video id="input_video" autoplay playsinline></video>
        <canvas id="output_canvas" width="640" height="480"></canvas>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const statusBar = document.getElementById('status-bar');

        // 1. åŒæ„æŒ‰éˆ•é‚è¼¯ï¼šé»æ“Šå¾Œæ‰é–‹å•Ÿç›¸æ©Ÿ
        document.getElementById('agree-btn').addEventListener('click', () => {
            document.getElementById('disclaimer-modal').style.display = 'none';
            statusBar.innerText = "è«‹é€€å¾Œï¼Œè®“é¡é ­æ‹åˆ°æ‚¨çš„é›™è…³...";
            startCamera();
        });

        // 2. AI é‹ç®—çµæœè™•ç†
        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                // æŠ“å–å·¦è…³é»ä½
                const leftAnkle = results.poseLandmarks[27];
                const leftHeel = results.poseLandmarks[29];
                const leftToe = results.poseLandmarks[31];
                
                // æŠ“å–å³è…³é»ä½
                const rightAnkle = results.poseLandmarks[28];
                const rightHeel = results.poseLandmarks[30];
                const rightToe = results.poseLandmarks[32];

                // ğŸŒŸ é˜²å‘†æ©Ÿåˆ¶ï¼šæª¢æŸ¥ã€Œå¯è¦‹åº¦ (visibility)ã€
                // ç¢ºä¿ AI çœŸçš„æœ‰çœ‹æ¸…æ¥šè…³ï¼Œè€Œä¸æ˜¯ç›²çŒœ (é–¾å€¼è¨­ç‚º 0.6)
                const isLeftVisible = leftAnkle.visibility > 0.6 && leftHeel.visibility > 0.6 && leftToe.visibility > 0.6;
                const isRightVisible = rightAnkle.visibility > 0.6 && rightHeel.visibility > 0.6 && rightToe.visibility > 0.6;

                if (!isLeftVisible && !isRightVisible) {
                    // å¦‚æœå…©éš»è…³éƒ½çœ‹ä¸æ¸…æ¥š
                    statusBar.innerText = "âŒ æœªåµæ¸¬åˆ°å®Œæ•´è…³éƒ¨ï¼Œè«‹èª¿æ•´ç«™ä½";
                    statusBar.style.backgroundColor = "#555"; // ç°è‰²è­¦å‘Š
                    canvasCtx.restore();
                    return; // ææ—©çµæŸï¼Œä¸å¾€ä¸‹è¨ˆç®—åç§»é‡
                }

                // --- å¦‚æœæœ‰æŠ“åˆ°è…³ï¼Œå°±ç•«å‡ºè…³éƒ¨ç‰¹å¾µé» ---
                const footPoints = [27, 28, 29, 30, 31, 32];
                footPoints.forEach(i => {
                    if (results.poseLandmarks[i].visibility > 0.6) {
                        const lm = results.poseLandmarks[i];
                        canvasCtx.beginPath();
                        canvasCtx.arc(lm.x * canvasElement.width, lm.y * canvasElement.height, 6, 0, 2 * Math.PI);
                        canvasCtx.fillStyle = "#f1c40f"; // é»ƒè‰²é»é»
                        canvasCtx.fill();
                    }
                });

                // 3. è¶³è¸åç§»é‹ç®—é‚è¼¯ (ä»¥å·¦è…³ç‚ºä¾‹ï¼Œè¨ˆç®—è…³è¸æ˜¯å¦åé›¢è…³è·Ÿèˆ‡è…³å°–çš„ä¸­å¿ƒ)
                let statusText = "âœ… é›™è…³æ”¯æ’ç©©å®š";
                let statusColor = "#27ae60"; // ç©©å®šç¶ è‰²
                
                // åˆ¤æ–·é–¾å€¼ (æ•¸å€¼è¶Šå¤§ä»£è¡¨å®¹éŒ¯ç‡è¶Šé«˜ï¼Œå»ºè­°ç¯„åœ 0.03 ~ 0.06)
                const offsetThreshold = 0.035; 

                if (isLeftVisible) {
                    const leftOffset = leftAnkle.x - (leftHeel.x + leftToe.x) / 2;
                    if (Math.abs(leftOffset) > offsetThreshold) {
                        statusText = "âš ï¸ å·¦è…³è¸åç§» (æ³¨æ„è¶³å¼“/è†è“‹å…§æ‰£)";
                        statusColor = "#e74c3c"; // è­¦å‘Šç´…
                    }
                }

                if (isRightVisible) {
                    const rightOffset = rightAnkle.x - (rightHeel.x + rightToe.x) / 2;
                    if (Math.abs(rightOffset) > offsetThreshold) {
                        statusText = "âš ï¸ å³è…³è¸åç§» (æ³¨æ„è¶³å¼“/è†è“‹å…§æ‰£)";
                        statusColor = "#e74c3c"; // è­¦å‘Šç´…
                    }
                }

                // æ›´æ–°ç•«é¢ç‹€æ…‹
                statusBar.innerText = statusText;
                statusBar.style.backgroundColor = statusColor;
            } else {
                // å®Œå…¨æ²’æŠ“åˆ°äºº
                statusBar.innerText = "è«‹ç«™åˆ°é¡é ­å‰æ–¹...";
                statusBar.style.backgroundColor = "#555";
            }
            canvasCtx.restore();
        }

        // åˆå§‹åŒ– AI æ¨¡å‹
        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        pose.onResults(onResults);

        // å•Ÿå‹•ç›¸æ©Ÿå‡½æ•¸ (è¢«åŒæ„æŒ‰éˆ•è§¸ç™¼)
        function startCamera() {
            const camera = new Camera(videoElement, {
                onFrame: async () => { await pose.send({image: videoElement}); },
                width: 640, height: 480
            });
            camera.start();
        }
    </script>
</body>
</html>